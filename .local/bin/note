#!/usr/bin/env bash
#
# Note taking.
 
DIR=~/Documents/notes
DATE=`date "+%Y/%m/%d"`
FILE=$DATE' notes.md'

if [ $# -gt 0 ]; then
    TITLE=$*

    found="$TMPDIR"notes.found.$RANDOM
    find $DIR -iname "*$TITLE*" | sed "s|$DIR/||" > $found

    declare -a notes
    count=0
    while read note; do
        notes[$count]=$note
        count=$((count + 1))
    done <$found
    rm $found

    if [ ${#notes[@]} -eq 0 ]; then
        mkdir -p "$DIR/$DATE"
        FILE="$DATE/$TITLE.md"
        echo "Creating new note: $FILE"
        find $DIR -type d -empty -not -path "*$DATE" -delete &
    elif [ ${#notes[@]} -eq 1 ]; then
        FILE=${notes[0]}
        echo "Opening note: $FILE"
    else
        for i in "${!notes[@]}"; do
            echo "[$i]: ${notes[$i]}"
        done

        echo
        echo -n "Which note? [0 - $i]: "
        read pick

        if [ $pick -eq $pick >/dev/null 2>&1 ] \
        && [ $pick -ge 0 ] \
        && [ $pick -le $i ]; then
            FILE=${notes[$pick]}
            echo "Opening note: $FILE"
        else
            echo "No such note: $pick"
            exit 1
        fi
    fi
fi

edit() {
    if hash mvim 2>/dev/null; then
        editor=mvim
    elif hash gvim 2>/dev/null; then
        editor=gvim
    elif hash $EDITOR 2>/dev/null; then
        editor=$EDITOR
    else
        echo 'No editor. Set EDITOR env first.'
        exit 1
    fi

    $editor "$@"
}

edit "$DIR/$FILE"
